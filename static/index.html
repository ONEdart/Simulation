<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stealth Code Storage - Upload & Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            important: true,
            corePlugins: {
                preflight: true,
            }
        }
    </script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }
        
        .file-card {
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }
        
        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
        }
        
        .upload-area {
            border: 3px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        
        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        .type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
        }
        
        .image-type { background-color: #dbeafe; color: #1e40af; }
        .doc-type { background-color: #f3e8ff; color: #6b21a8; }
        .pdf-type { background-color: #fee2e2; color: #991b1b; }
        .archive-type { background-color: #fef3c7; color: #92400e; }
        .other-type { background-color: #d1fae5; color: #065f46; }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="app">
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Stealth Code Storage</h1>
                        <p class="text-gray-600 text-sm">Code-Based Encoded Storage System</p>
                    </div>
                    <div class="flex space-x-2">
                        <a href="/" class="px-3 py-1.5 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 transition">
                            Upload & Manage
                        </a>
                        <a href="/viewer.html" class="px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm font-medium hover:bg-gray-50 transition">
                            File Viewer
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-6">
            <div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="bg-white rounded-lg p-4 shadow border">
                    <div class="text-xs text-gray-500">Total Files</div>
                    <div class="text-xl font-bold text-gray-900">{{ stats.files?.total || 0 }}</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow border">
                    <div class="text-xs text-gray-500">Storage Used</div>
                    <div class="text-xl font-bold text-gray-900">{{ formatSize(stats.files?.total_size || 0) }}</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow border">
                    <div class="text-xs text-gray-500">Code Fragments</div>
                    <div class="text-xl font-bold text-gray-900">{{ stats.files?.total_chunks || 0 }}</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow border">
                    <div class="text-xs text-gray-500">Repositories</div>
                    <div class="text-xl font-bold text-gray-900">{{ Object.keys(stats.repos || {}).length }}</div>
                </div>
            </div>

            <div class="mb-8 bg-white rounded-xl p-6 shadow border">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Upload File</h2>
                
                <div 
                    @dragover.prevent="dragover = true"
                    @dragleave.prevent="dragover = false"
                    @drop.prevent="handleDrop"
                    :class="['upload-area rounded-lg p-8 text-center cursor-pointer', dragover ? 'dragover' : '']"
                >
                    <input 
                        type="file" 
                        id="fileInput" 
                        @change="handleFileSelect"
                        class="hidden"
                        multiple
                    >
                    
                    <div class="text-gray-400 mb-3">
                        <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                    
                    <p class="text-base text-gray-700 mb-1">Drop files here or click to select</p>
                    <p class="text-xs text-gray-500">Files will be encoded and hidden in source code files</p>
                    
                    <label for="fileInput" class="inline-block mt-4 px-4 py-2 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 transition cursor-pointer">
                        Select Files
                    </label>
                </div>

                <div v-if="uploading" class="mt-6 space-y-3">
                    <div v-for="upload in uploadQueue" :key="upload.file.name" class="border rounded p-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-medium text-gray-900 truncate text-sm">{{ upload.file.name }}</span>
                            <span class="text-xs text-gray-500">{{ formatSize(upload.file.size) }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div 
                                class="progress-bar bg-blue-600 h-1.5 rounded-full"
                                :style="{ width: upload.progress + '%' }"
                            ></div>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-600">
                                {{ upload.status }}
                            </span>
                            <span class="text-xs font-medium">
                                {{ upload.progress }}%
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-6 shadow border">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900">Stored Files</h2>
                    <div class="flex space-x-2">
                        <button 
                            @click="refreshFiles"
                            class="px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm font-medium hover:bg-gray-50 transition flex items-center"
                        >
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Refresh
                        </button>
                        <button 
                            @click="showStatsModal = true"
                            class="px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm font-medium hover:bg-gray-50 transition flex items-center"
                        >
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            System Stats
                        </button>
                        <button 
                            @click="cleanupSystem"
                            class="px-3 py-1.5 bg-red-600 text-white rounded text-sm font-medium hover:bg-red-700 transition"
                        >
                            Cleanup
                        </button>
                    </div>
                </div>

                <div v-if="loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="mt-2 text-gray-600 text-sm">Loading files...</p>
                </div>

                <div v-else-if="files.length === 0" class="text-center py-8">
                    <div class="text-gray-400 mb-3">
                        <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-1">No files uploaded yet</h3>
                    <p class="text-gray-600 text-sm">Upload your first file to see it here</p>
                </div>

                <div v-else class="space-y-4">
                    <div 
                        v-for="file in files" 
                        :key="file.id"
                        class="file-card bg-white border border-gray-200 rounded-lg p-4"
                    >
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-gray-900 truncate text-sm" :title="file.filename">{{ file.filename }}</h3>
                                <p class="text-xs text-gray-500 mt-0.5">{{ formatSize(file.size) }} • {{ formatDate(file.upload_time) }}</p>
                            </div>
                            <span :class="['type-badge text-xs', getTypeClass(file.mime_type)]">
                                {{ getTypeLabel(file.mime_type) }}
                            </span>
                        </div>
                        
                        <div class="flex items-center justify-between text-xs text-gray-600 mb-3">
                            <div>
                                <span>Code Fragments: </span>
                                <span class="font-medium">{{ file.chunk_count }}</span>
                            </div>
                            <div class="font-mono text-xs bg-gray-100 px-2 py-0.5 rounded">
                                {{ file.id.substring(0, 8) }}...
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-2 pt-3 border-t border-gray-100">
                            <a 
                                :href="`/viewer.html?id=${file.id}`"
                                target="_blank"
                                class="px-3 py-1 bg-blue-600 text-white rounded text-xs font-medium hover:bg-blue-700 transition"
                            >
                                Preview
                            </a>
                            <a 
                                :href="`/api/file/${file.id}`"
                                class="px-3 py-1 border border-gray-300 text-gray-700 rounded text-xs font-medium hover:bg-gray-50 transition"
                            >
                                Download
                            </a>
                            <button 
                                @click="deleteFile(file.id, file.filename)"
                                class="px-3 py-1 border border-red-300 text-red-700 rounded text-xs font-medium hover:bg-red-50 transition"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="mt-8 border-t border-gray-200 py-4">
            <div class="max-w-7xl mx-auto px-4 text-center text-gray-600 text-xs">
                <p>Stealth Code Storage • Encoded Data Fragmentation & Distributed Repository System</p>
            </div>
        </footer>

        <!-- Stats Modal -->
        <div v-if="showStatsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900">System Statistics</h2>
                        <button @click="showStatsModal = false" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div v-if="loadingStats" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <p class="mt-2 text-gray-600 text-sm">Loading statistics...</p>
                    </div>
                    
                    <div v-else class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-sm text-gray-500">Total Files</div>
                                <div class="text-xl font-bold text-gray-900">{{ stats.files?.total || 0 }}</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-sm text-gray-500">Total Size</div>
                                <div class="text-xl font-bold text-gray-900">{{ formatSize(stats.files?.total_size || 0) }}</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-sm text-gray-500">Code Fragments</div>
                                <div class="text-xl font-bold text-gray-900">{{ stats.files?.total_chunks || 0 }}</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-sm text-gray-500">Avg Fragment Size</div>
                                <div class="text-xl font-bold text-gray-900">{{ formatSize(stats.files?.total_size / stats.files?.total_chunks || 0) }}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg" v-if="stats.system">
                            <div class="text-sm font-medium text-gray-700 mb-2">System Info</div>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Total Repositories</span>
                                    <span class="font-medium">{{ stats.system?.total_repos || 0 }}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Repo Capacity</span>
                                    <span class="font-medium">{{ formatSize(stats.system?.repo_capacity || 0) }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-sm font-medium text-gray-700 mb-2">Repository Distribution</div>
                            <div v-if="Object.keys(stats.repos || {}).length === 0" class="text-sm text-gray-500 text-center py-4">
                                No repositories loaded yet
                            </div>
                            <div v-else class="space-y-2">
                                <div v-for="(repo, repoId) in stats.repos" :key="repoId" class="text-sm">
                                    <div class="flex justify-between mb-1">
                                        <span class="text-gray-600">{{ repoId }}</span>
                                        <span class="font-medium">{{ formatSize(repo.size) }} ({{ Math.round(repo.utilization) }}%)</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-blue-600 h-1.5 rounded-full" :style="{ width: Math.min(repo.utilization, 100) + '%' }"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const files = ref([]);
                const stats = ref({});
                const loading = ref(true);
                const uploading = ref(false);
                const uploadQueue = ref([]);
                const dragover = ref(false);
                const showStatsModal = ref(false);
                const loadingStats = ref(false);

                const formatSize = (bytes) => {
                    if (!bytes || bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };

                const formatDate = (dateString) => {
                    try {
                        const date = new Date(dateString);
                        return date.toLocaleDateString('id-ID', {
                            day: '2-digit',
                            month: 'short',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch {
                        return dateString;
                    }
                };

                const getTypeClass = (mimeType) => {
                    if (!mimeType) return 'other-type';
                    if (mimeType.startsWith('image/')) return 'image-type';
                    if (mimeType.includes('document') || mimeType.includes('word') || mimeType.includes('excel') || mimeType.includes('powerpoint')) 
                        return 'doc-type';
                    if (mimeType === 'application/pdf') return 'pdf-type';
                    if (mimeType.includes('zip') || mimeType.includes('tar') || mimeType.includes('rar') || mimeType.includes('7z'))
                        return 'archive-type';
                    return 'other-type';
                };

                const getTypeLabel = (mimeType) => {
                    if (!mimeType) return 'File';
                    if (mimeType.startsWith('image/')) return 'Image';
                    if (mimeType.includes('document') || mimeType.includes('word')) return 'Document';
                    if (mimeType.includes('excel')) return 'Spreadsheet';
                    if (mimeType.includes('powerpoint')) return 'Presentation';
                    if (mimeType === 'application/pdf') return 'PDF';
                    if (mimeType.includes('zip') || mimeType.includes('tar') || mimeType.includes('rar')) 
                        return 'Archive';
                    if (mimeType.startsWith('text/')) return 'Text';
                    if (mimeType.startsWith('video/')) return 'Video';
                    if (mimeType.startsWith('audio/')) return 'Audio';
                    return 'File';
                };

                const loadFiles = async () => {
                    try {
                        loading.value = true;
                        const response = await fetch('/api/files');
                        if (!response.ok) throw new Error('Failed to load files');
                        const data = await response.json();
                        files.value = data.files || [];
                    } catch (error) {
                        console.error('Error loading files:', error);
                        alert('Failed to load files: ' + error.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const loadStats = async () => {
                    try {
                        loadingStats.value = true;
                        const response = await fetch('/api/stats');
                        if (!response.ok) throw new Error('Failed to load stats');
                        const data = await response.json();
                        stats.value = data;
                    } catch (error) {
                        console.error('Error loading stats:', error);
                    } finally {
                        loadingStats.value = false;
                    }
                };

                const handleFileSelect = (event) => {
                    const selectedFiles = Array.from(event.target.files);
                    processFiles(selectedFiles);
                    event.target.value = '';
                };

                const handleDrop = (event) => {
                    dragover.value = false;
                    const droppedFiles = Array.from(event.dataTransfer.files);
                    processFiles(droppedFiles);
                };

                const processFiles = (fileList) => {
                    fileList.forEach(file => {
                        uploadQueue.value.push({
                            file: file,
                            progress: 0,
                            status: 'Waiting...'
                        });
                    });
                    
                    if (!uploading.value) {
                        processUploadQueue();
                    }
                };

                const processUploadQueue = async () => {
                    if (uploadQueue.value.length === 0) {
                        uploading.value = false;
                        return;
                    }
                    
                    uploading.value = true;
                    const upload = uploadQueue.value[0];
                    
                    try {
                        upload.status = 'Preparing...';
                        upload.progress = 5;
                        
                        const formData = new FormData();
                        formData.append('file', upload.file);
                        
                        const xhr = new XMLHttpRequest();
                        
                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                const progress = Math.round((e.loaded / e.total) * 100);
                                upload.progress = Math.min(99, progress);
                            }
                        });
                        
                        xhr.addEventListener('load', () => {
                            if (xhr.status === 200) {
                                upload.progress = 100;
                                upload.status = 'Completed';
                                
                                setTimeout(() => {
                                    uploadQueue.value.shift();
                                    loadFiles();
                                    loadStats();
                                    processUploadQueue();
                                }, 500);
                            } else {
                                upload.status = 'Failed';
                                alert(`Upload failed: ${xhr.responseText}`);
                                uploadQueue.value.shift();
                                processUploadQueue();
                            }
                        });
                        
                        xhr.addEventListener('error', () => {
                            upload.status = 'Failed';
                            alert('Upload failed: Network error');
                            uploadQueue.value.shift();
                            processUploadQueue();
                        });
                        
                        upload.status = 'Uploading...';
                        xhr.open('POST', '/api/upload');
                        xhr.send(formData);
                        
                    } catch (error) {
                        upload.status = 'Failed';
                        alert(`Upload error: ${error.message}`);
                        uploadQueue.value.shift();
                        processUploadQueue();
                    }
                };

                const deleteFile = async (fileId, filename) => {
                    if (!confirm(`Delete file "${filename}"? This action cannot be undone.`)) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/file/${fileId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            await loadFiles();
                            await loadStats();
                        } else {
                            const error = await response.json();
                            alert(`Delete failed: ${error.error}`);
                        }
                    } catch (error) {
                        console.error('Delete error:', error);
                        alert('Failed to delete file');
                    }
                };

                const refreshFiles = async () => {
                    await loadFiles();
                    await loadStats();
                };

                const cleanupSystem = async () => {
                    if (!confirm('Clean up temporary files and perform maintenance?')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/cleanup', {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            alert(`Cleanup completed: ${result.deleted} temporary files deleted`);
                            await loadStats();
                        } else {
                            const error = await response.json();
                            alert(`Cleanup failed: ${error.error}`);
                        }
                    } catch (error) {
                        console.error('Cleanup error:', error);
                        alert('Cleanup failed');
                    }
                };

                onMounted(async () => {
                    await loadFiles();
                    await loadStats();
                });

                return {
                    files,
                    stats,
                    loading,
                    uploading,
                    uploadQueue,
                    dragover,
                    showStatsModal,
                    loadingStats,
                    formatSize,
                    formatDate,
                    getTypeClass,
                    getTypeLabel,
                    handleFileSelect,
                    handleDrop,
                    deleteFile,
                    refreshFiles,
                    cleanupSystem
                };
            }
        }).mount('#app');
    </script>
</body>
</html>